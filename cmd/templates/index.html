<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>hTranscode - Distributed Video Transcoding</title>
    <link href="/static/styles.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-background min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <header class="mb-8">
            <h1 class="text-4xl font-bold text-foreground mb-2">hTranscode</h1>
            <p class="text-muted-foreground">Distributed Video Transcoding System</p>
        </header>

        <!-- File Browser Section -->
        <div class="card p-6 mb-6">
            <h2 class="text-2xl font-semibold text-card-foreground mb-4">Upload Videos</h2>
            
            <!-- File Upload Section -->
            <div class="mb-4 p-4 bg-muted rounded-lg">
                <h3 class="text-lg font-medium text-foreground mb-3">Upload Videos from Your Computer</h3>
                <div class="flex gap-2 items-center">
                    <div class="flex-1 relative">
                        <input type="file" id="videoUpload" 
                               class="hidden"
                               accept=".mp4,.avi,.mkv,.mov,.flv,.wmv,.webm,.m4v,.3gp"
                               multiple
                               onchange="updateFileInputDisplay()">
                        <button onclick="document.getElementById('videoUpload').click()" 
                                class="input flex items-center justify-center w-full cursor-pointer hover:bg-zinc-800 transition-colors">
                            <span id="fileInputText" class="text-zinc-400">Choose video files...</span>
                        </button>
                    </div>
                    <button onclick="uploadFiles()" 
                            class="button button-primary h-10 px-4">
                        Upload
                    </button>
                </div>
                <p class="text-sm text-muted-foreground mt-2">
                    Select video files from your computer to upload. Max size: <span id="maxUploadSize">2GB</span> per file.
                </p>
                
                <!-- Upload Progress -->
                <div id="uploadProgress" class="hidden mt-3">
                    <div class="flex justify-between mb-1">
                        <span class="text-sm text-foreground">Uploading...</span>
                        <span class="text-sm text-muted-foreground" id="uploadPercent">0%</span>
                    </div>
                    <div class="w-full bg-border rounded-full h-2">
                        <div class="bg-primary h-2 rounded-full transition-all duration-300" 
                             id="uploadProgressBar" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- Quick Access to Uploads -->
            <div class="mb-4">
                <button onclick="browseUploads()" 
                        class="button button-secondary h-10 px-4">
                    Show Uploaded Files
                </button>
            </div>

            <!-- Video List -->
            <div id="videoList" class="hidden">
                <h3 class="text-lg font-medium text-foreground mb-3">Videos Found</h3>
                <div id="videoContainer" class="space-y-2">
                    <!-- Videos will be populated here -->
                </div>
            </div>
        </div>

        <!-- Encoding Options Section -->
        <div id="encodingOptions" class="card p-6 mb-6 hidden">
            <h2 class="text-2xl font-semibold text-card-foreground mb-4">Encoding Options</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-foreground mb-2">Codec</label>
                    <select class="input" disabled>
                        <option selected>H.264</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-foreground mb-2">Bitrate</label>
                    <select class="input" disabled>
                        <option selected>10 Mbps</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-foreground mb-2">Resolution</label>
                    <select class="input" disabled>
                        <option selected>1080p</option>
                    </select>
                </div>
            </div>

            <div class="mt-6">
                <button onclick="startEncoding()" 
                        class="button button-primary h-10 px-6">
                    Start Encoding
                </button>
            </div>
        </div>

        <!-- Progress Section -->
        <div id="progressSection" class="card p-6 mb-6 hidden">
            <h2 class="text-2xl font-semibold text-card-foreground mb-4">Encoding Progress</h2>
            <div id="jobsContainer" class="space-y-4">
                <!-- Progress bars will be shown here -->
            </div>
        </div>

        <!-- Worker Status -->
        <div class="card p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-semibold text-card-foreground">Worker Status</h2>
                <div class="text-sm text-muted-foreground">
                    <span id="workerCount">0</span> workers connected
                </div>
            </div>
            <div id="workerStatus" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <div class="bg-muted rounded-lg p-4">
                    <p class="text-sm text-muted-foreground">No workers connected</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="mt-16 pb-4 text-center">
        <p class="text-xs font-mono text-muted-foreground">
            Made with ‚ù§Ô∏è by Matt <img src="https://flagcdn.com/16x12/us.png" alt="USA" class="inline w-4 h-3"> and Josie <img src="https://flagcdn.com/16x12/do.png" alt="DOM" class="inline w-4 h-3">
        </p>
    </footer>

    <!-- Latency Chart Popup -->
    <div id="latencyPopup" class="fixed bg-popover border border-border rounded-lg shadow-xl p-4 z-50 hidden" style="width: 320px; height: 220px;">
        <div class="flex justify-between items-center mb-2">
            <h4 class="font-medium text-popover-foreground text-sm">Latency (ms)</h4>
            <div class="flex items-center gap-1 text-xs text-muted-foreground">
                <span>Min: <span id="minLatency" class="text-green-400">--</span></span>
                <span>Avg: <span id="avgLatency" class="text-blue-400">--</span></span>
                <span>Max: <span id="maxLatency" class="text-red-400">--</span></span>
            </div>
        </div>
        <div class="relative" style="height: 160px;">
            <canvas id="latencyChart"></canvas>
        </div>
    </div>

    <!-- Worker Details Modal -->
    <div id="workerModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-card border border-border rounded-lg shadow-2xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-auto">
            <!-- Modal Header -->
            <div class="flex justify-between items-center p-6 border-b border-border">
                <h2 class="text-xl font-semibold text-card-foreground" id="modalWorkerName">Worker Details</h2>
                <button onclick="closeWorkerModal()" class="text-muted-foreground hover:text-foreground text-2xl">&times;</button>
            </div>
            
            <!-- Modal Content -->
            <div class="p-6 space-y-6">
                <!-- Worker Status -->
                <div class="flex items-center gap-3">
                    <div class="flex items-center gap-2">
                        <div class="w-3 h-3 rounded-full" id="modalStatusIndicator"></div>
                        <span class="font-medium text-foreground" id="modalWorkerStatus">Status</span>
                    </div>
                    <span class="text-sm text-muted-foreground" id="modalWorkerIP">IP Address</span>
                </div>

                <!-- Usage Metrics in 3 Rows -->
                <div class="space-y-4">
                    <!-- GPU Usage Row -->
                    <div class="bg-muted rounded-lg p-4">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="font-medium text-foreground flex items-center gap-2">
                                <span id="modalGPUVendorLogo">üéÆ</span> GPU Usage
                            </h3>
                        </div>
                        <div class="space-y-2">
                            <div class="flex justify-between text-sm">
                                <span class="text-muted-foreground">GPU</span>
                                <span class="text-foreground" id="modalGPUInfo">GPU Info</span>
                            </div>
                            <div class="w-full bg-border rounded-full h-2">
                                <div class="bg-green-500 h-2 rounded-full transition-all duration-300" id="modalGPUUsageBar" style="width: 0%"></div>
                            </div>
                            <div class="flex justify-between text-xs text-muted-foreground">
                                <span>0%</span>
                                <span id="modalGPUUsagePercent">0%</span>
                                <span>100%</span>
                            </div>
                        </div>
                    </div>

                    <!-- CPU Usage Row -->
                    <div class="bg-muted rounded-lg p-4">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="font-medium text-foreground flex items-center gap-2">
                                <span id="modalCPUVendorLogo">üíª</span> CPU Usage
                            </h3>
                            <span class="text-sm text-muted-foreground" id="modalCPUCores">CPU Cores</span>
                        </div>
                        <div class="space-y-2">
                            <div class="flex justify-between text-sm">
                                <span class="text-muted-foreground">CPU</span>
                                <span class="text-foreground" id="modalCPUInfo">CPU Info</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="text-muted-foreground">Workload</span>
                                <span class="text-foreground" id="modalCPUJobs">Jobs</span>
                            </div>
                            <div class="w-full bg-border rounded-full h-2">
                                <div class="bg-blue-500 h-2 rounded-full transition-all duration-300" id="modalCPUUsageBar" style="width: 0%"></div>
                            </div>
                            <div class="flex justify-between text-xs text-muted-foreground">
                                <span>0%</span>
                                <span id="modalCPUUsageText">0% CPU</span>
                                <span>100%</span>
                            </div>
                        </div>
                    </div>

                    <!-- Network Usage Row -->
                    <div class="bg-muted rounded-lg p-4">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="font-medium text-foreground flex items-center gap-2">
                                <span class="text-purple-500">üåê</span> Network
                            </h3>
                            <span class="text-sm text-muted-foreground" id="modalConnectionType">Connection</span>
                        </div>
                        <div class="space-y-2">
                            <div class="flex justify-between text-sm">
                                <span class="text-muted-foreground">Latency</span>
                                <span class="text-foreground" id="modalLatencyValue">0ms</span>
                            </div>
                            <div class="w-full bg-border rounded-full h-2">
                                <div class="bg-purple-500 h-2 rounded-full transition-all duration-300" id="modalLatencyBar" style="width: 0%"></div>
                            </div>
                            <div class="flex justify-between text-xs text-muted-foreground">
                                <span class="text-green-400">Good (&lt;50ms)</span>
                                <span class="text-yellow-400">Fair (50-100ms)</span>
                                <span class="text-red-400">Poor (&gt;100ms)</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Latency Chart -->
                <div class="bg-muted rounded-lg p-4">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="font-medium text-foreground">Latency History</h3>
                        <div class="flex items-center gap-2 text-xs text-muted-foreground">
                            <span>Min: <span id="modalMinLatency" class="text-green-400">--</span></span>
                            <span>Avg: <span id="modalAvgLatency" class="text-blue-400">--</span></span>
                            <span>Max: <span id="modalMaxLatency" class="text-red-400">--</span></span>
                        </div>
                    </div>
                    <div class="relative" style="height: 200px;">
                        <canvas id="modalLatencyChart"></canvas>
                    </div>
                </div>

                <!-- Connection Info -->
                <div class="bg-muted rounded-lg p-4">
                    <h3 class="font-medium text-foreground mb-3">Connection Details</h3>
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div>
                            <span class="text-muted-foreground">Worker ID:</span>
                            <span class="text-foreground ml-2" id="modalWorkerID">ID</span>
                        </div>
                        <div>
                            <span class="text-muted-foreground">Last Ping:</span>
                            <span class="text-foreground ml-2" id="modalLastPing">Time</span>
                        </div>
                        <div>
                            <span class="text-muted-foreground">Connected:</span>
                            <span class="text-foreground ml-2" id="modalConnectedTime">Duration</span>
                        </div>
                        <div>
                            <span class="text-muted-foreground">Protocol:</span>
                            <span class="text-foreground ml-2 flex items-center gap-1" id="modalProtocol">
                                <span id="modalProtocolText">WSS (Secure)</span>
                                <span id="modalProtocolIcon" class="cursor-pointer hover:scale-110 transition-transform" onclick="openSecurityModal()" title="View security details"></span>
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Security Details Modal -->
    <div id="securityModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="bg-background rounded-lg shadow-xl max-w-md w-full mx-4">
            <div class="flex justify-between items-center p-4 border-b border-border">
                <h2 class="text-lg font-semibold text-foreground flex items-center gap-2">
                    <span id="securityModalIcon">üîí</span>
                    Connection Security
                </h2>
                <button onclick="closeSecurityModal()" class="text-muted-foreground hover:text-foreground">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div class="p-4 space-y-4">
                <!-- Security Level -->
                <div class="bg-muted rounded-lg p-3">
                    <div class="flex items-center gap-2 mb-2">
                        <span id="securityLevelIcon">üõ°Ô∏è</span>
                        <span class="font-medium text-foreground" id="securityLevel">Enterprise Grade</span>
                    </div>
                    <p class="text-sm text-muted-foreground" id="securityDescription">Your connection is protected with military-grade encryption</p>
                </div>

                <!-- Technical Details -->
                <div class="space-y-3">
                    <div class="flex justify-between">
                        <span class="text-muted-foreground">TLS Version:</span>
                        <span class="text-foreground font-mono text-sm" id="tlsVersion">TLS 1.3</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-muted-foreground">Cipher Suite:</span>
                        <span class="text-foreground font-mono text-sm" id="cipherSuite">AES_256_GCM_SHA384</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-muted-foreground">Key Exchange:</span>
                        <span class="text-foreground font-mono text-sm" id="keyExchange">X25519</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-muted-foreground">Protocol:</span>
                        <span class="text-foreground font-mono text-sm" id="protocol">HTTP/2 + WSS</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-muted-foreground">Forward Secrecy:</span>
                        <span class="text-green-500 font-mono text-sm">‚úì Yes</span>
                    </div>
                </div>

                <!-- Certificate Info -->
                <div class="bg-muted rounded-lg p-3">
                    <h3 class="font-medium text-foreground mb-2">Certificate</h3>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-muted-foreground">Issuer:</span>
                            <span class="text-foreground">hTranscode (Self-signed)</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-muted-foreground">Valid Until:</span>
                            <span class="text-foreground" id="certExpiry">1 year</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-muted-foreground">Key Size:</span>
                            <span class="text-foreground">RSA 2048-bit</span>
                        </div>
                    </div>
                </div>

                <!-- Performance Benefits -->
                <div class="bg-green-50 dark:bg-green-900/20 rounded-lg p-3">
                    <h3 class="font-medium text-green-800 dark:text-green-200 mb-2">Security Benefits</h3>
                    <ul class="text-sm text-green-700 dark:text-green-300 space-y-1">
                        <li>‚Ä¢ 0-RTT connection resumption</li>
                        <li>‚Ä¢ Perfect forward secrecy</li>
                        <li>‚Ä¢ Protection against downgrade attacks</li>
                        <li>‚Ä¢ Modern cryptographic algorithms</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        let selectedVideos = [];
        let ws = null;
        let latencyData = {}; // Store latency history for each worker
        let latencyChart = null;
        let modalLatencyChart = null;
        let currentModalWorker = null;

        // Helper functions to get vendor logos
        function getGPUVendorLogo(gpuInfo) {
            if (!gpuInfo || gpuInfo === 'No GPU' || gpuInfo === 'None') {
                return '<span class="text-gray-400">üö´</span>'; // No GPU
            }
            
            const gpuLower = gpuInfo.toLowerCase();
            
            if (gpuLower.includes('nvidia')) {
                // NVIDIA official logo
                return `<svg width="20" height="20" viewBox="0 0 24 24" fill="#76B900">
                    <path d="M8.948 8.798v-1.43a6.7 6.7 0 0 1 .424-.018c3.922-.124 6.493 3.374 6.493 3.374s-2.774 3.851-5.75 3.851c-.398 0-.787-.062-1.158-.185v-4.346c1.528.185 1.837.857 2.747 2.385l2.04-1.714s-1.492-1.952-4-1.952a6.016 6.016 0 0 0-.796.035m0-4.735v2.138l.424-.027c5.45-.185 9.01 4.47 9.01 4.47s-4.08 4.964-8.33 4.964c-.37 0-.733-.035-1.095-.097v1.325c.3.035.61.062.91.062 3.957 0 6.82-2.023 9.593-4.408.459.371 2.34 1.263 2.73 1.652-2.633 2.208-8.772 3.984-12.253 3.984-.335 0-.653-.018-.971-.053v1.864H24V4.063zm0 10.326v1.131c-3.657-.654-4.673-4.46-4.673-4.46s1.758-1.944 4.673-2.262v1.237H8.94c-1.528-.186-2.73 1.245-2.73 1.245s.68 2.412 2.739 3.11M2.456 10.9s2.164-3.197 6.5-3.533V6.201C4.153 6.59 0 10.653 0 10.653s2.35 6.802 8.948 7.42v-1.237c-4.84-.6-6.492-5.936-6.492-5.936z"/>
                </svg>`;
            } else if (gpuLower.includes('amd') || gpuLower.includes('radeon')) {
                // AMD official logo
                return `<svg width="20" height="20" viewBox="0 0 24 24" fill="#ED1C24">
                    <path d="M18.324 9.137l1.559 1.56h2.556v2.557L24 14.814V9.137zM2 9.52l-2 4.96h1.309l.37-.982H3.9l.408.982h1.338L3.432 9.52zm4.209 0v4.955h1.238v-3.092l1.338 1.562h.188l1.338-1.556v3.091h1.238V9.52H10.47l-1.592 1.845L7.287 9.52zm6.283 0v4.96h2.057c1.979 0 2.88-1.046 2.88-2.472 0-1.36-.937-2.488-2.747-2.488zm1.237.91h.792c1.17 0 1.63.711 1.63 1.57 0 .728-.372 1.572-1.616 1.572h-.806zm-10.985.273l.791 1.932H2.008zm17.137.307l-1.604 1.603v2.25h2.246l1.604-1.607h-2.246z"/>
                </svg>`;
            } else if (gpuLower.includes('intel')) {
                // Intel official logo
                return `<svg width="20" height="20" viewBox="0 0 24 24" fill="#0071C5">
                    <path d="M20.42 7.345v9.18h1.651v-9.18zM0 7.475v1.737h1.737V7.474zm9.78.352v6.053c0 .513.044.945.13 1.292.087.34.235.618.44.828.203.21.475.359.803.451.334.093.754.136 1.255.136h.216v-1.533c-.24 0-.445-.012-.593-.037a.672.672 0 0 1-.39-.173.693.693 0 0 1-.173-.377 4.002 4.002 0 0 1-.037-.606v-2.182h1.193v-1.416h-1.193V7.827zm-3.505 2.312c-.396 0-.76.08-1.082.241-.327.161-.6.384-.822.668l-.087.117v-.902H2.658v6.256h1.639v-3.214c.018-.588.16-1.02.433-1.299.29-.297.642-.445 1.044-.445.476 0 .841.149 1.082.433.235.284.359.686.359 1.2v3.324h1.663V12.97c.006-.89-.229-1.595-.686-2.09-.458-.495-1.1-.742-1.917-.742zm10.065.006a3.252 3.252 0 0 0-2.306.946c-.29.29-.525.637-.692 1.033a3.145 3.145 0 0 0-.254 1.273c0 .452.08.878.241 1.274.161.395.39.742.674 1.032.284.29.637.526 1.045.693.408.173.86.26 1.342.26 1.397 0 2.262-.637 2.782-1.23l-1.187-.904c-.248.297-.841.699-1.583.699-.464 0-.847-.105-1.138-.321a1.588 1.588 0 0 1-.593-.872l-.019-.056h4.915v-.587c0-.451-.08-.872-.235-1.267a3.393 3.393 0 0 0-.661-1.033 3.013 3.013 0 0 0-1.02-.692 3.345 3.345 0 0 0-1.311-.248zm-16.297.118v6.256h1.651v-6.256zm16.278 1.286c1.132 0 1.664.797 1.664 1.255l-3.32.006c0-.458.525-1.255 1.656-1.261zm7.073 3.814a.606.606 0 0 0-.606.606.606.606 0 0 0 .606.606.606.606 0 0 0 .606-.606.606.606 0 0 0-.606-.606zm-.008.105a.5.5 0 0 1 .002 0 .5.5 0 0 1 .5.501.5.5 0 0 1-.5.5.5.5 0 0 1-.5-.5.5.5 0 0 1 .498-.5zm-.233.155v.699h.13v-.285h.093l.173.285h.136l-.18-.297a.191.191 0 0 0 .118-.056c.03-.03.05-.074.05-.136 0-.068-.02-.117-.063-.154-.037-.038-.105-.056-.185-.056zm.13.099h.154c.019 0 .037.006.056.012a.064.064 0 0 1 .037.031c.013.013.012.031.012.056a.124.124 0 0 1-.012.055.164.164 0 0 1-.037.031c-.019.006-.037.013-.056.013h-.154Z"/>
                </svg>`;
            }
            
            // Generic GPU icon for unknown vendors
            return `<svg width="20" height="20" viewBox="0 0 24 24" fill="#22c55e">
                <rect x="2" y="6" width="20" height="12" rx="2" stroke="currentColor" stroke-width="2" fill="none"/>
                <rect x="6" y="9" width="4" height="6" fill="currentColor"/>
                <rect x="14" y="9" width="4" height="6" fill="currentColor"/>
            </svg>`;
        }

        function getCPUVendorLogo(cpuInfo) {
            if (!cpuInfo || cpuInfo === 'Unknown CPU') {
                return '<span class="text-gray-400">‚ùì</span>'; // Unknown CPU
            }
            
            const cpuLower = cpuInfo.toLowerCase();
            
            if (cpuLower.includes('intel')) {
                // Intel official logo
                return `<svg width="20" height="20" viewBox="0 0 24 24" fill="#0071C5">
                    <path d="M20.42 7.345v9.18h1.651v-9.18zM0 7.475v1.737h1.737V7.474zm9.78.352v6.053c0 .513.044.945.13 1.292.087.34.235.618.44.828.203.21.475.359.803.451.334.093.754.136 1.255.136h.216v-1.533c-.24 0-.445-.012-.593-.037a.672.672 0 0 1-.39-.173.693.693 0 0 1-.173-.377 4.002 4.002 0 0 1-.037-.606v-2.182h1.193v-1.416h-1.193V7.827zm-3.505 2.312c-.396 0-.76.08-1.082.241-.327.161-.6.384-.822.668l-.087.117v-.902H2.658v6.256h1.639v-3.214c.018-.588.16-1.02.433-1.299.29-.297.642-.445 1.044-.445.476 0 .841.149 1.082.433.235.284.359.686.359 1.2v3.324h1.663V12.97c.006-.89-.229-1.595-.686-2.09-.458-.495-1.1-.742-1.917-.742zm10.065.006a3.252 3.252 0 0 0-2.306.946c-.29.29-.525.637-.692 1.033a3.145 3.145 0 0 0-.254 1.273c0 .452.08.878.241 1.274.161.395.39.742.674 1.032.284.29.637.526 1.045.693.408.173.86.26 1.342.26 1.397 0 2.262-.637 2.782-1.23l-1.187-.904c-.248.297-.841.699-1.583.699-.464 0-.847-.105-1.138-.321a1.588 1.588 0 0 1-.593-.872l-.019-.056h4.915v-.587c0-.451-.08-.872-.235-1.267a3.393 3.393 0 0 0-.661-1.033 3.013 3.013 0 0 0-1.02-.692 3.345 3.345 0 0 0-1.311-.248zm-16.297.118v6.256h1.651v-6.256zm16.278 1.286c1.132 0 1.664.797 1.664 1.255l-3.32.006c0-.458.525-1.255 1.656-1.261zm7.073 3.814a.606.606 0 0 0-.606.606.606.606 0 0 0 .606.606.606.606 0 0 0 .606-.606.606.606 0 0 0-.606-.606zm-.008.105a.5.5 0 0 1 .002 0 .5.5 0 0 1 .5.501.5.5 0 0 1-.5.5.5.5 0 0 1-.5-.5.5.5 0 0 1 .498-.5zm-.233.155v.699h.13v-.285h.093l.173.285h.136l-.18-.297a.191.191 0 0 0 .118-.056c.03-.03.05-.074.05-.136 0-.068-.02-.117-.063-.154-.037-.038-.105-.056-.185-.056zm.13.099h.154c.019 0 .037.006.056.012a.064.064 0 0 1 .037.031c.013.013.012.031.012.056a.124.124 0 0 1-.012.055.164.164 0 0 1-.037.031c-.019.006-.037.013-.056.013h-.154Z"/>
                </svg>`;
            } else if (cpuLower.includes('amd')) {
                // AMD official logo
                return `<svg width="20" height="20" viewBox="0 0 24 24" fill="#ED1C24">
                    <path d="M18.324 9.137l1.559 1.56h2.556v2.557L24 14.814V9.137zM2 9.52l-2 4.96h1.309l.37-.982H3.9l.408.982h1.338L3.432 9.52zm4.209 0v4.955h1.238v-3.092l1.338 1.562h.188l1.338-1.556v3.091h1.238V9.52H10.47l-1.592 1.845L7.287 9.52zm6.283 0v4.96h2.057c1.979 0 2.88-1.046 2.88-2.472 0-1.36-.937-2.488-2.747-2.488zm1.237.91h.792c1.17 0 1.63.711 1.63 1.57 0 .728-.372 1.572-1.616 1.572h-.806zm-10.985.273l.791 1.932H2.008zm17.137.307l-1.604 1.603v2.25h2.246l1.604-1.607h-2.246z"/>
                </svg>`;
            } else if (cpuLower.includes('via')) {
                // VIA purple logo
                return `<svg width="20" height="20" viewBox="0 0 24 24" fill="#6b46c1">
                    <circle cx="12" cy="12" r="10"/>
                    <path d="M8 8h8v8H8z" fill="white"/>
                </svg>`;
            }
            
            // Generic CPU icon for unknown vendors
            return `<svg width="20" height="20" viewBox="0 0 24 24" fill="#3b82f6">
                <rect x="4" y="4" width="16" height="16" rx="2" stroke="currentColor" stroke-width="2" fill="none"/>
                <rect x="8" y="8" width="8" height="8" fill="currentColor"/>
                <rect x="10" y="10" width="4" height="4" fill="white"/>
            </svg>`;
        }

        // Initialize latency charts
        function initLatencyChart() {
            const ctx = document.getElementById('latencyChart').getContext('2d');
            
            latencyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Latency (ms)',
                        data: [],
                        borderColor: '#22c55e', // Green from our design system
                        backgroundColor: 'rgba(34, 197, 94, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 0,
                        pointHoverRadius: 4,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 0
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            enabled: false
                        }
                    },
                    scales: {
                        x: {
                            display: false
                        },
                        y: {
                            display: true,
                            beginAtZero: true,
                            grid: {
                                color: '#27272a' // zinc-800
                            },
                            ticks: {
                                color: '#a1a1aa', // zinc-400
                                font: {
                                    size: 10
                                },
                                callback: function(value) {
                                    return value + 'ms';
                                }
                            }
                        }
                    }
                }
            });
        }

        function initModalLatencyChart() {
            const ctx = document.getElementById('modalLatencyChart').getContext('2d');
            
            modalLatencyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Latency (ms)',
                        data: [],
                        borderColor: '#22c55e',
                        backgroundColor: 'rgba(34, 197, 94, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 2,
                        pointHoverRadius: 4,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 0
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            enabled: true,
                            callbacks: {
                                label: function(context) {
                                    return context.parsed.y.toFixed(2) + 'ms';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            grid: {
                                color: '#27272a'
                            },
                            ticks: {
                                display: false
                            }
                        },
                        y: {
                            display: true,
                            beginAtZero: true,
                            grid: {
                                color: '#27272a'
                            },
                            ticks: {
                                color: '#a1a1aa',
                                font: {
                                    size: 12
                                },
                                callback: function(value) {
                                    return value + 'ms';
                                }
                            }
                        }
                    }
                }
            });
        }

        // Store latency data for a worker
        function storeLatencyData(workerId, latency) {
            // Convert from nanoseconds to actual ms for display
            const latencyMs = latency / 1000000;
            console.log(`Storing latency data for worker ${workerId}: ${latencyMs.toFixed(2)}ms (raw: ${latency})`);
            
            if (!latencyData[workerId]) {
                latencyData[workerId] = [];
            }
            
            const now = new Date();
            latencyData[workerId].push({
                time: now,
                latency: latencyMs // Store in milliseconds for the chart
            });
            
            // Keep only last 200 data points (about 50 seconds of data with 250ms intervals)
            if (latencyData[workerId].length > 200) {
                latencyData[workerId].shift();
            }
            
            console.log(`Worker ${workerId} now has ${latencyData[workerId].length} latency data points`);
        }

        // Update the chart for a specific worker
        function updateChart(workerId) {
            console.log(`Updating chart for worker ${workerId}`);
            
            if (!latencyChart || !latencyData[workerId]) {
                console.log(`Chart or data not available for worker ${workerId}`);
                // Reset statistics to default
                document.getElementById('minLatency').textContent = '--';
                document.getElementById('maxLatency').textContent = '--';
                document.getElementById('avgLatency').textContent = '--';
                return;
            }
            
            const data = latencyData[workerId];
            console.log(`Worker ${workerId} chart data:`, data);
            
            // Create simple labels (just indices)
            const labels = data.map((_, index) => index);
            const values = data.map(point => point.latency);
            
            latencyChart.data.labels = labels;
            latencyChart.data.datasets[0].data = values;
            
            // Calculate statistics
            if (values.length > 0) {
                const minLatency = Math.min(...values);
                const maxLatency = Math.max(...values);
                const avgLatency = values.reduce((a, b) => a + b, 0) / values.length;
                
                // Update statistics display
                document.getElementById('minLatency').textContent = minLatency.toFixed(2) + 'ms';
                document.getElementById('maxLatency').textContent = maxLatency.toFixed(2) + 'ms';
                document.getElementById('avgLatency').textContent = avgLatency.toFixed(2) + 'ms';
                
                // Update color based on average latency
                if (avgLatency < 50) {
                    latencyChart.data.datasets[0].borderColor = '#22c55e'; // green-500
                    latencyChart.data.datasets[0].backgroundColor = 'rgba(34, 197, 94, 0.1)';
                } else if (avgLatency < 100) {
                    latencyChart.data.datasets[0].borderColor = '#eab308'; // yellow-500
                    latencyChart.data.datasets[0].backgroundColor = 'rgba(234, 179, 8, 0.1)';
                } else {
                    latencyChart.data.datasets[0].borderColor = '#dc2626'; // red-600
                    latencyChart.data.datasets[0].backgroundColor = 'rgba(220, 38, 38, 0.1)';
                }
            } else {
                // No data, reset statistics
                document.getElementById('minLatency').textContent = '--';
                document.getElementById('maxLatency').textContent = '--';
                document.getElementById('avgLatency').textContent = '--';
            }
            
            latencyChart.update('none');
            console.log(`Chart updated for worker ${workerId} with ${values.length} data points`);
        }

        // Update modal chart for a specific worker
        function updateModalChart(workerId) {
            if (!modalLatencyChart || !latencyData[workerId]) {
                // Reset modal statistics to default
                document.getElementById('modalMinLatency').textContent = '--';
                document.getElementById('modalMaxLatency').textContent = '--';
                document.getElementById('modalAvgLatency').textContent = '--';
                return;
            }
            
            const data = latencyData[workerId];
            const labels = data.map((_, index) => index);
            const values = data.map(point => point.latency);
            
            modalLatencyChart.data.labels = labels;
            modalLatencyChart.data.datasets[0].data = values;
            
            // Calculate statistics
            if (values.length > 0) {
                const minLatency = Math.min(...values);
                const maxLatency = Math.max(...values);
                const avgLatency = values.reduce((a, b) => a + b, 0) / values.length;
                
                // Update modal statistics display
                document.getElementById('modalMinLatency').textContent = minLatency.toFixed(2) + 'ms';
                document.getElementById('modalMaxLatency').textContent = maxLatency.toFixed(2) + 'ms';
                document.getElementById('modalAvgLatency').textContent = avgLatency.toFixed(2) + 'ms';
                
                // Update color based on average latency
                if (avgLatency < 50) {
                    modalLatencyChart.data.datasets[0].borderColor = '#22c55e';
                    modalLatencyChart.data.datasets[0].backgroundColor = 'rgba(34, 197, 94, 0.1)';
                } else if (avgLatency < 100) {
                    modalLatencyChart.data.datasets[0].borderColor = '#eab308';
                    modalLatencyChart.data.datasets[0].backgroundColor = 'rgba(234, 179, 8, 0.1)';
                } else {
                    modalLatencyChart.data.datasets[0].borderColor = '#dc2626';
                    modalLatencyChart.data.datasets[0].backgroundColor = 'rgba(220, 38, 38, 0.1)';
                }
            }
            
            modalLatencyChart.update('none');
        }

        // Open worker details modal
        function openWorkerModal(worker) {
            currentModalWorker = worker.id;
            
            // Update modal header
            document.getElementById('modalWorkerName').textContent = worker.name;
            document.getElementById('modalWorkerIP').textContent = worker.ipAddress || 'Unknown';
            document.getElementById('modalWorkerID').textContent = worker.id;
            
            // Update status
            const statusColors = {
                'online': { bg: 'bg-green-500', text: 'Online' },
                'idle': { bg: 'bg-blue-500', text: 'Idle' },
                'busy': { bg: 'bg-yellow-500', text: 'Busy' },
                'offline': { bg: 'bg-red-500', text: 'Offline' }
            };
            const status = statusColors[worker.status] || { bg: 'bg-gray-500', text: 'Unknown' };
            document.getElementById('modalStatusIndicator').className = `w-3 h-3 rounded-full ${status.bg}`;
            document.getElementById('modalWorkerStatus').textContent = status.text;
            
            // Update GPU info
            const gpuInfo = worker.gpu || 'No GPU';
            document.getElementById('modalGPUInfo').textContent = gpuInfo;
            document.getElementById('modalGPUVendorLogo').innerHTML = getGPUVendorLogo(gpuInfo);
            
            // Use real GPU usage data from worker
            const gpuUsage = worker.gpuUsage || 0;
            document.getElementById('modalGPUUsageBar').style.width = `${gpuUsage}%`;
            document.getElementById('modalGPUUsagePercent').textContent = `${gpuUsage.toFixed(1)}%`;
            
            // Update CPU info - use real CPU usage data
            const cpuUsage = worker.cpuUsage || 0;
            const cpuInfo = worker.cpu || 'Unknown CPU';
            
            // Parse CPU info to separate model and core count
            let cpuModel = cpuInfo;
            let coreInfo = 'Multi-core';
            
            // Extract core count from CPU string like "AMD Ryzen 9 5950X 16-Core Processor (32 cores)"
            const coreMatch = cpuInfo.match(/\((\d+)\s+cores?\)/i);
            if (coreMatch) {
                coreInfo = coreMatch[1] + ' cores';
                // Remove the core count from the model name
                cpuModel = cpuInfo.replace(/\s*\(\d+\s+cores?\)/i, '').trim();
            }
            
            document.getElementById('modalCPUInfo').textContent = cpuModel;
            document.getElementById('modalCPUJobs').textContent = `${worker.currentJobs}/${worker.maxJobs} jobs`;
            document.getElementById('modalCPUUsageBar').style.width = `${cpuUsage}%`;
            document.getElementById('modalCPUUsageText').textContent = `${cpuUsage.toFixed(1)}% CPU`;
            document.getElementById('modalCPUCores').textContent = coreInfo;
            document.getElementById('modalCPUVendorLogo').innerHTML = getCPUVendorLogo(cpuInfo);
            
            // Update network info
            const latencyMs = (worker.latency || 0) / 1000000; // Convert from nanoseconds to ms
            document.getElementById('modalLatencyValue').textContent = `${latencyMs.toFixed(2)}ms`;
            
            // Calculate latency bar position (0-150ms scale)
            const latencyPercent = Math.min((latencyMs / 150) * 100, 100);
            document.getElementById('modalLatencyBar').style.width = `${latencyPercent}%`;
            
            // Update connection type
            document.getElementById('modalConnectionType').textContent = worker.ipAddress?.startsWith('127.') ? 'Local' : 'Remote';
            
            // Update protocol with security indication
            const isSecure = window.location.protocol === 'https:';
            const protocolIcon = document.getElementById('modalProtocolIcon');
            const protocolText = document.getElementById('modalProtocolText');
            
            if (isSecure) {
                // Golden lock for secure connection
                protocolIcon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="#DAA520" class="bi bi-lock" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M8 0a4 4 0 0 1 4 4v2.05a2.5 2.5 0 0 1 2 2.45v5a2.5 2.5 0 0 1-2.5 2.5h-7A2.5 2.5 0 0 1 2 13.5v-5a2.5 2.5 0 0 1 2-2.45V4a4 4 0 0 1 4-4M4.5 7A1.5 1.5 0 0 0 3 8.5v5A1.5 1.5 0 0 0 4.5 15h7a1.5 1.5 0 0 0 1.5-1.5v-5A1.5 1.5 0 0 0 11.5 7zM8 1a3 3 0 0 0-3 3v2h6V4a3 3 0 0 0-3-3"/>
                </svg>`;
                protocolText.textContent = 'WSS (Secure)';
            } else {
                // Red unlock for insecure connection
                protocolIcon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="#DC2626" class="bi bi-unlock" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M12 0a4 4 0 0 1 4 4v2.5h-1V4a3 3 0 1 0-6 0v2h.5A2.5 2.5 0 0 1 12 8.5v5A2.5 2.5 0 0 1 9.5 16h-7A2.5 2.5 0 0 1 0 13.5v-5A2.5 2.5 0 0 1 2.5 6H8V4a4 4 0 0 1 4-4M2.5 7A1.5 1.5 0 0 0 1 8.5v5A1.5 1.5 0 0 0 2.5 15h7a1.5 1.5 0 0 0 1.5-1.5v-5A1.5 1.5 0 0 0 9.5 7z"/>
                </svg>`;
                protocolText.textContent = 'WS (Insecure)';
            }
            
            // Update connection details
            document.getElementById('modalLastPing').textContent = new Date(worker.lastPing).toLocaleTimeString();
            document.getElementById('modalConnectedTime').textContent = 'Active';
            
            // Store worker data for live updates
            window.currentModalWorkerData = worker;
            
            // Update charts
            updateModalChart(worker.id);
            
            // Show modal
            document.getElementById('workerModal').classList.remove('hidden');
        }

        // Close worker details modal
        function closeWorkerModal() {
            document.getElementById('workerModal').classList.add('hidden');
            currentModalWorker = null;
            window.currentModalWorkerData = null;
        }

        // Close modal when clicking outside
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('workerModal');
            if (event.target === modal) {
                closeWorkerModal();
            }
            
            const securityModal = document.getElementById('securityModal');
            if (event.target === securityModal) {
                closeSecurityModal();
            }
        });

        // Security modal functions
        function openSecurityModal() {
            console.log('Security modal opening...');
            const isSecure = window.location.protocol === 'https:';
            
            // Update modal content based on security level
            if (isSecure) {
                document.getElementById('securityModalIcon').innerHTML = 'üîí';
                document.getElementById('securityLevel').textContent = 'Enterprise Grade';
                document.getElementById('securityDescription').textContent = 'Your connection is protected with military-grade encryption';
                document.getElementById('securityLevelIcon').textContent = 'üõ°Ô∏è';
                
                // TLS 1.3 details
                document.getElementById('tlsVersion').textContent = 'TLS 1.3';
                document.getElementById('cipherSuite').textContent = 'AES_256_GCM_SHA384';
                document.getElementById('keyExchange').textContent = 'X25519';
                document.getElementById('protocol').textContent = 'HTTP/2 + WSS';
            } else {
                document.getElementById('securityModalIcon').innerHTML = 'üîì';
                document.getElementById('securityLevel').textContent = 'Basic (Insecure)';
                document.getElementById('securityDescription').textContent = 'Your connection is not encrypted and may be intercepted';
                document.getElementById('securityLevelIcon').textContent = '‚ö†Ô∏è';
                
                // HTTP details
                document.getElementById('tlsVersion').textContent = 'None';
                document.getElementById('cipherSuite').textContent = 'None (Plaintext)';
                document.getElementById('keyExchange').textContent = 'None';
                document.getElementById('protocol').textContent = 'HTTP/1.1 + WS';
            }
            
            document.getElementById('securityModal').classList.remove('hidden');
        }

        function closeSecurityModal() {
            document.getElementById('securityModal').classList.add('hidden');
        }

        // Keyboard support for modals
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeWorkerModal();
                closeSecurityModal();
            }
        });

        // Live update modal data
        function updateModalLiveData() {
            if (window.currentModalWorkerData && !document.getElementById('workerModal').classList.contains('hidden')) {
                // Update Last Ping time continuously
                if (window.currentModalWorkerData.lastPing) {
                    document.getElementById('modalLastPing').textContent = new Date(window.currentModalWorkerData.lastPing).toLocaleTimeString();
                }
            }
        }

        // Refresh modal data when new worker data arrives
        function refreshModalIfOpen(workers) {
            if (currentModalWorker && !document.getElementById('workerModal').classList.contains('hidden')) {
                const updatedWorker = workers.find(w => w.id === currentModalWorker);
                if (updatedWorker) {
                    // Update stored worker data
                    window.currentModalWorkerData = updatedWorker;
                    
                    // Update Last Ping
                    document.getElementById('modalLastPing').textContent = new Date(updatedWorker.lastPing).toLocaleTimeString();
                    
                    // Update other live fields
                    const latencyMs = (updatedWorker.latency || 0) / 1000000;
                    document.getElementById('modalLatencyValue').textContent = `${latencyMs.toFixed(2)}ms`;
                    
                    // Update usage bars
                    const gpuUsage = updatedWorker.gpuUsage || 0;
                    const cpuUsage = updatedWorker.cpuUsage || 0;
                    document.getElementById('modalGPUUsageBar').style.width = `${gpuUsage}%`;
                    document.getElementById('modalGPUUsagePercent').textContent = `${gpuUsage.toFixed(1)}%`;
                    document.getElementById('modalCPUUsageBar').style.width = `${cpuUsage}%`;
                    document.getElementById('modalCPUUsageText').textContent = `${cpuUsage.toFixed(1)}% CPU`;
                    
                    // Update job count
                    document.getElementById('modalCPUJobs').textContent = `${updatedWorker.currentJobs}/${updatedWorker.maxJobs} jobs`;
                }
            }
        }

        // Initialize WebSocket connection
        function initWebSocket() {
            // Automatically detect protocol and construct WebSocket URL
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const host = window.location.host;
            const wsUrl = `${protocol}//${host}/ws`;
            
            ws = new WebSocket(wsUrl);
            
            ws.onopen = function() {
                console.log('WebSocket connected to:', wsUrl);
            };
            
            ws.onmessage = function(event) {
                const data = JSON.parse(event.data);
                handleWebSocketMessage(data);
            };
            
            ws.onclose = function() {
                console.log('WebSocket disconnected');
                // Reconnect after 3 seconds
                setTimeout(initWebSocket, 3000);
            };
        }

        // Fetch worker status from API
        function fetchWorkerStatus() {
            fetch('/api/workers')
                .then(response => response.json())
                .then(workers => {
                    updateWorkerStatus(workers);
                })
                .catch(error => {
                    console.error('Error fetching worker status:', error);
                });
        }

        function displayVideos(videos) {
            const videoList = document.getElementById('videoList');
            const videoContainer = document.getElementById('videoContainer');
            const encodingOptions = document.getElementById('encodingOptions');
            
            videoContainer.innerHTML = '';
            selectedVideos = [];
            
            if (videos.length === 0) {
                videoContainer.innerHTML = '<p class="text-muted-foreground">No videos found in this folder</p>';
            } else {
                videos.forEach(video => {
                    const videoItem = document.createElement('div');
                    videoItem.className = 'flex items-center p-3 bg-muted rounded-lg hover:bg-accent transition duration-150';
                    
                    const sizeInMB = (video.size / (1024 * 1024)).toFixed(2);
                    
                    // Add upload indicator if it's an uploaded file
                    const uploadIndicator = video.isUploaded ? 
                        '<span class="badge badge-info text-xs ml-2">Uploaded</span>' : '';
                    
                    videoItem.innerHTML = `
                        <input type="checkbox" 
                               class="mr-3 h-4 w-4 text-primary rounded accent-primary" 
                               value="${video.path}"
                               onchange="toggleVideo('${video.path}')">
                        <div class="flex-1">
                            <div class="flex items-center">
                                <p class="font-medium text-foreground">${video.name}</p>
                                ${uploadIndicator}
                            </div>
                            <p class="text-sm text-muted-foreground">${sizeInMB} MB</p>
                        </div>
                        ${video.isUploaded ? `
                            <button onclick="deleteVideo('${video.path}', this)" 
                                    class="ml-3 text-red-500 hover:text-red-700 transition-colors p-2 rounded hover:bg-red-50"
                                    title="Delete video">
                                üóëÔ∏è
                            </button>
                        ` : ''}
                    `;
                    
                    videoContainer.appendChild(videoItem);
                });
            }
            
            videoList.classList.remove('hidden');
            if (videos.length > 0) {
                encodingOptions.classList.remove('hidden');
            }
        }

        function toggleVideo(path) {
            const index = selectedVideos.indexOf(path);
            if (index > -1) {
                selectedVideos.splice(index, 1);
            } else {
                selectedVideos.push(path);
            }
        }

        function startEncoding() {
            if (selectedVideos.length === 0) {
                alert('Please select at least one video to encode');
                return;
            }
            
            const progressSection = document.getElementById('progressSection');
            progressSection.classList.remove('hidden');
            
            selectedVideos.forEach(videoPath => {
                fetch('/api/encode', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        videoPath: videoPath,
                        preset: 'h264_10mbps_1080p'
                    })
                })
                .then(response => response.json())
                .then(job => {
                    addJobProgress(job);
                    console.log('Started encoding job:', job.id);
                })
                .catch(error => {
                    console.error('Error starting encoding:', error);
                    alert('Failed to start encoding: ' + error.message);
                });
            });
            
            // Start polling for job updates
            startJobPolling();
        }

        function addJobProgress(job) {
            const jobsContainer = document.getElementById('jobsContainer');
            
            const jobElement = document.createElement('div');
            jobElement.id = `job-${job.id}`;
            jobElement.className = 'bg-muted rounded-lg p-4';
            
            const fileName = job.videoPath.split('/').pop();
            
            jobElement.innerHTML = `
                <div class="flex justify-between items-center mb-2">
                    <span class="font-medium text-foreground">${fileName}</span>
                    <div class="flex items-center gap-2">
                        <span class="text-sm text-muted-foreground job-status">${job.status}</span>
                        <button onclick="deleteJob('${job.id}', this)" 
                                class="text-red-500 hover:text-red-700 transition-colors p-1 rounded hover:bg-red-50"
                                title="Cancel/Delete job">
                            ‚ùå
                        </button>
                    </div>
                </div>
                <div class="w-full bg-border rounded-full h-2">
                    <div class="bg-primary h-2 rounded-full transition-all duration-300 job-progress-bar" 
                         style="width: ${job.progress}%"></div>
                </div>
                <div class="mt-2 text-sm text-muted-foreground">
                    <span class="job-progress-text">${job.progress}%</span> complete
                </div>
            `;
            
            jobsContainer.appendChild(jobElement);
        }

        function deleteJob(jobId, buttonElement) {
            if (!confirm('Are you sure you want to cancel/delete this job?')) {
                return;
            }
            
            fetch('/api/jobs/delete', {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ jobId: jobId })
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    // Remove the job item from the UI
                    buttonElement.closest('.bg-muted').remove();
                    console.log('Job deleted:', jobId);
                } else {
                    alert('Failed to delete job: ' + result.message);
                }
            })
            .catch(error => {
                console.error('Error deleting job:', error);
                alert('Failed to delete job');
            });
        }

        function startJobPolling() {
            // Poll for job updates every 2 seconds
            setInterval(fetchJobUpdates, 2000);
        }

        function fetchJobUpdates() {
            fetch('/api/jobs')
                .then(response => response.json())
                .then(jobs => {
                    updateJobProgress(jobs);
                })
                .catch(error => {
                    console.error('Error fetching job updates:', error);
                });
        }

        function updateJobProgress(jobs) {
            jobs.forEach(job => {
                const jobElement = document.getElementById(`job-${job.id}`);
                if (jobElement) {
                    // Update status
                    const statusElement = jobElement.querySelector('.job-status');
                    if (statusElement) {
                        statusElement.textContent = job.status;
                    }
                    
                    // Update progress bar
                    const progressBar = jobElement.querySelector('.job-progress-bar');
                    if (progressBar) {
                        progressBar.style.width = `${job.progress}%`;
                    }
                    
                    // Update progress text
                    const progressText = jobElement.querySelector('.job-progress-text');
                    if (progressText) {
                        progressText.textContent = `${job.progress}%`;
                    }
                    
                    // Change progress bar color based on status
                    if (progressBar) {
                        if (job.status === 'completed') {
                            progressBar.className = 'bg-green-500 h-2 rounded-full transition-all duration-300 job-progress-bar';
                        } else if (job.status === 'failed') {
                            progressBar.className = 'bg-red-500 h-2 rounded-full transition-all duration-300 job-progress-bar';
                        } else {
                            progressBar.className = 'bg-primary h-2 rounded-full transition-all duration-300 job-progress-bar';
                        }
                    }
                }
            });
        }

        function handleWebSocketMessage(data) {
            if (data.type === 'progress') {
                updateJobProgress(data.jobs);
            } else if (data.type === 'worker_status') {
                updateWorkerStatus(data.workers);
            }
        }

        function updateWorkerStatus(workers) {
            const workerStatus = document.getElementById('workerStatus');
            const workerCount = document.getElementById('workerCount');
            
            workerStatus.innerHTML = '';
            workerCount.textContent = workers.length;
            
            // Refresh modal if open
            refreshModalIfOpen(workers);
            
            if (workers.length === 0) {
                workerStatus.innerHTML = `
                    <div class="bg-muted rounded-lg p-4">
                        <p class="text-sm text-muted-foreground">No workers connected</p>
                    </div>
                `;
            } else {
                workers.forEach(worker => {
                    // Store latency data for charting
                    if (worker.latency > 0) {
                        storeLatencyData(worker.id, worker.latency);
                    }
                    
                    const statusColors = {
                        'online': 'badge-success',
                        'idle': 'badge-info',
                        'busy': 'badge-warning',
                        'offline': 'badge-error'
                    };
                    const statusColor = statusColors[worker.status] || 'badge-secondary';
                    
                    const workerElement = document.createElement('div');
                    workerElement.className = 'bg-muted rounded-lg p-4 relative cursor-pointer hover:bg-accent transition-colors duration-200';
                    
                    // Calculate usage percentages
                    const cpuUsage = worker.cpuUsage || 0;
                    const gpuUsage = worker.gpuUsage || 0;
                    const latencyMs = (worker.latency || 0) / 1000000; // Convert from nanoseconds to ms
                    const gpuInfo = worker.gpu || 'No GPU';
                    
                    workerElement.innerHTML = `
                        <div class="absolute top-2 right-2">
                            <span class="badge ${statusColor} text-xs">
                                ${worker.status}
                            </span>
                        </div>
                        <h4 class="font-medium text-foreground mb-3 pr-16">${worker.name}</h4>
                        
                        <!-- 3-Row Usage Display -->
                        <div class="space-y-3">
                            <!-- GPU Usage Row -->
                            <div class="flex items-center gap-3">
                                <span class="text-sm">${getGPUVendorLogo(gpuInfo)}</span>
                                <div class="flex-1">
                                    <div class="flex justify-between items-center mb-1">
                                        <span class="text-xs text-muted-foreground">GPU</span>
                                        <span class="text-xs text-foreground">${gpuInfo !== 'No GPU' && gpuInfo !== 'None' ? `${gpuUsage.toFixed(1)}%` : 'N/A'}</span>
                                    </div>
                                    <div class="w-full bg-border rounded-full h-1.5">
                                        <div class="bg-green-500 h-1.5 rounded-full transition-all duration-300" 
                                             style="width: ${gpuInfo !== 'No GPU' && gpuInfo !== 'None' ? gpuUsage : 0}%"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- CPU Usage Row -->
                            <div class="flex items-center gap-3">
                                <span class="text-sm">${getCPUVendorLogo(worker.cpu || 'Unknown CPU')}</span>
                                <div class="flex-1">
                                    <div class="flex justify-between items-center mb-1">
                                        <span class="text-xs text-muted-foreground">CPU</span>
                                        <span class="text-xs text-foreground">${cpuUsage.toFixed(1)}%</span>
                                    </div>
                                    <div class="w-full bg-border rounded-full h-1.5">
                                        <div class="bg-blue-500 h-1.5 rounded-full transition-all duration-300" 
                                             style="width: ${cpuUsage}%"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Network Usage Row -->
                            <div class="flex items-center gap-3">
                                <span class="text-purple-500 text-sm">üåê</span>
                                <div class="flex-1">
                                    <div class="flex justify-between items-center mb-1">
                                        <span class="text-xs text-muted-foreground">Network</span>
                                        <span class="text-xs text-foreground">${latencyMs.toFixed(1)}ms</span>
                                    </div>
                                    <div class="w-full bg-border rounded-full h-1.5">
                                        <div class="h-1.5 rounded-full transition-all duration-300 ${
                                            latencyMs < 50 ? 'bg-green-500' : 
                                            latencyMs < 100 ? 'bg-yellow-500' : 'bg-red-500'
                                        }" style="width: ${Math.min((latencyMs / 150) * 100, 100)}%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-3 text-xs text-muted-foreground">
                            Click for details ‚Ä¢ IP: ${worker.ipAddress || 'Unknown'}
                            ${worker.cpu ? ` ‚Ä¢ ${worker.cpu.split('(')[0].trim().substring(0, 25)}${worker.cpu.split('(')[0].trim().length > 25 ? '...' : ''}` : ''}
                        </div>
                    `;
                    
                    // Add click event to open modal
                    workerElement.addEventListener('click', () => openWorkerModal(worker));
                    
                    workerStatus.appendChild(workerElement);
                    
                    // Update modal chart if this worker's modal is currently shown
                    if (currentModalWorker === worker.id) {
                        updateModalChart(worker.id);
                    }
                });
            }
        }

        function uploadFiles() {
            const fileInput = document.getElementById('videoUpload');
            const files = fileInput.files;
            
            if (files.length === 0) {
                alert('Please select at least one video file to upload');
                return;
            }
            
            // Show progress bar
            const progressDiv = document.getElementById('uploadProgress');
            const progressBar = document.getElementById('uploadProgressBar');
            const progressText = document.getElementById('uploadPercent');
            
            progressDiv.classList.remove('hidden');
            
            let totalFiles = files.length;
            let uploadedFiles = 0;
            let failedUploads = [];
            
            function uploadFile(file, index) {
                const formData = new FormData();
                formData.append('videoFile', file);
                
                const xhr = new XMLHttpRequest();
                
                xhr.upload.addEventListener('progress', function(e) {
                    if (e.lengthComputable) {
                        const fileProgress = (e.loaded / e.total) * 100;
                        const totalProgress = ((uploadedFiles + (fileProgress / 100)) / totalFiles) * 100;
                        progressBar.style.width = totalProgress + '%';
                        progressText.textContent = Math.round(totalProgress) + '%';
                    }
                });
                
                xhr.addEventListener('load', function() {
                    if (xhr.status === 200) {
                        uploadedFiles++;
                        console.log(`File ${file.name} uploaded successfully`);
                    } else {
                        failedUploads.push(file.name);
                        console.error(`Failed to upload ${file.name}: ${xhr.responseText}`);
                    }
                    
                    // Check if all files are processed
                    if (uploadedFiles + failedUploads.length === totalFiles) {
                        setTimeout(() => {
                            progressDiv.classList.add('hidden');
                            progressBar.style.width = '0%';
                            progressText.textContent = '0%';
                            
                            // Reset file input
                            fileInput.value = '';
                            updateFileInputDisplay();
                            
                            // Show results
                            if (failedUploads.length === 0) {
                                alert(`Successfully uploaded ${uploadedFiles} file(s)!`);
                            } else {
                                alert(`Uploaded ${uploadedFiles} file(s). Failed: ${failedUploads.join(', ')}`);
                            }
                            
                            // Auto-refresh uploads if currently viewing them
                            const videoList = document.getElementById('videoList');
                            if (!videoList.classList.contains('hidden')) {
                                browseUploads();
                            }
                        }, 500);
                    }
                });
                
                xhr.addEventListener('error', function() {
                    failedUploads.push(file.name);
                    console.error(`Network error uploading ${file.name}`);
                });
                
                xhr.open('POST', '/api/upload');
                xhr.send(formData);
            }
            
            // Upload files one by one to avoid overwhelming the server
            for (let i = 0; i < files.length; i++) {
                uploadFile(files[i], i);
            }
        }

        function browseUploads() {
            fetch('/api/uploads')
                .then(response => response.json())
                .then(uploads => {
                    if (uploads.length === 0) {
                        // Show friendly message for no uploads
                        const videoList = document.getElementById('videoList');
                        const videoContainer = document.getElementById('videoContainer');
                        
                        videoContainer.innerHTML = `
                            <div class="text-center p-8 bg-muted rounded-lg">
                                <div class="text-4xl mb-4">üìÅ</div>
                                <h3 class="text-lg font-medium text-foreground mb-2">No uploaded files</h3>
                                <p class="text-muted-foreground mb-4">Upload some video files to get started with encoding.</p>
                                <button onclick="document.getElementById('videoUpload').click()" 
                                        class="button button-primary h-10 px-4">
                                    Choose Files to Upload
                                </button>
                            </div>
                        `;
                        
                        videoList.classList.remove('hidden');
                        document.getElementById('encodingOptions').classList.add('hidden');
                    } else {
                        displayVideos(uploads);
                    }
                })
                .catch(error => {
                    console.error('Error fetching uploads:', error);
                    
                    // Show friendly error message instead of generic alert
                    const videoList = document.getElementById('videoList');
                    const videoContainer = document.getElementById('videoContainer');
                    
                    videoContainer.innerHTML = `
                        <div class="text-center p-8 bg-muted rounded-lg border-2 border-red-200">
                            <div class="text-4xl mb-4">‚ö†Ô∏è</div>
                            <h3 class="text-lg font-medium text-foreground mb-2">Unable to load uploads</h3>
                            <p class="text-muted-foreground mb-4">There was a problem accessing your uploaded files. Please try again.</p>
                            <button onclick="browseUploads()" 
                                    class="button button-secondary h-10 px-4">
                                Try Again
                            </button>
                        </div>
                    `;
                    
                    videoList.classList.remove('hidden');
                    document.getElementById('encodingOptions').classList.add('hidden');
                });
        }

        // Fetch and apply configuration
        function loadConfiguration() {
            fetch('/api/config')
                .then(response => response.json())
                .then(config => {
                    // Update max upload size display
                    const maxUploadElement = document.getElementById('maxUploadSize');
                    if (maxUploadElement && config.storage) {
                        maxUploadElement.textContent = config.storage.max_upload_size_mb + 'MB';
                    }
                    
                    // Update file input accept attribute if needed
                    const fileInput = document.getElementById('videoUpload');
                    if (fileInput && config.storage && config.storage.allowed_formats) {
                        fileInput.setAttribute('accept', config.storage.allowed_formats.join(','));
                    }
                    
                    console.log('Configuration loaded:', config);
                })
                .catch(error => {
                    console.error('Error loading configuration:', error);
                });
        }

        function deleteVideo(filePath, buttonElement) {
            if (!confirm('Are you sure you want to delete this video?')) {
                return;
            }
            
            fetch('/api/uploads/delete', {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ filePath: filePath })
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    // Remove the video item from the UI
                    buttonElement.closest('.flex').remove();
                    
                    // Refresh the video list
                    browseUploads();
                } else {
                    alert('Failed to delete video: ' + result.message);
                }
            })
            .catch(error => {
                console.error('Error deleting video:', error);
                alert('Failed to delete video');
            });
        }

        function updateFileInputDisplay() {
            const fileInput = document.getElementById('videoUpload');
            const fileInputText = document.getElementById('fileInputText');
            
            if (fileInput.files.length === 0) {
                fileInputText.textContent = 'Choose video files...';
                fileInputText.className = 'text-zinc-400';
            } else if (fileInput.files.length === 1) {
                fileInputText.textContent = fileInput.files[0].name;
                fileInputText.className = 'text-zinc-50';
            } else {
                fileInputText.textContent = `${fileInput.files.length} files selected`;
                fileInputText.className = 'text-zinc-50';
            }
        }

        // Initialize on page load
        window.onload = function() {
            initWebSocket();
            initLatencyChart();
            initModalLatencyChart();
            loadConfiguration();
            fetchWorkerStatus();
            
            // Fetch worker status every 2 seconds for smooth updates without overwhelming the server
            setInterval(fetchWorkerStatus, 2000);
            
            // Update modal live data every second for real-time Last Ping updates
            setInterval(updateModalLiveData, 1000);
        };
    </script>
</body>
</html> 